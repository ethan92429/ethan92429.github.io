---
layout: post
title: "Adding Custom ODK Widget"
---

I needed to add a Bluetooth ODK widget that connects to a serial bluetooth device, parses the text stream to obtain the piece I want, and then sends it on with the rest of the form. First I found out that the "widget" will actually have to be a separate app. The form defined on the agreggate server is defined such that the Collect app will launch the specified app when it gets to the aproppriate spot in the form. The third party app then opens up and once the user is done, returns the data to the collect app, at which point the form continues. I will document exactly how I created a simple Bluetooth app that connects to an instrument, reads it, parses it, and displays the inferred reading to the user, then returns the data to the collect app. 

The first step is to ensure that I know how to write the required XLS forms for agreggate, so I started by modifying a simple camera opening form I generated on the [ODK build website](http://build.opendatakit.org/). I was able to get this form to request a third party app by modifying the body => input => "appearance" tag to be the package name of the app I was planning to build. Something like: "org.thirdparty.app.ActivityName". 

I then began looking for simple demo apps to base my code off of. I quickly found this [SO post](http://stackoverflow.com/questions/13450406/how-to-receive-serial-data-using-android-bluetooth) that included all the code for an initial bluetooth app to get my feet wet. This app was able to connect to my HC-06 bluetooth module just by changing "MattsBlueTooth" on roughly line 108 to "HC-06". Upon running this code, I noticed that it was only printing one line of serial output from the HC-06 at a time. To modify it to print more, I extended the textView box, and then accumulated all the strings that were passed along into one long string. That is the data that I want to parse and then format and send back to aggregate. I parsed using java regular expressions I found on [this post](http://www.tutorialspoint.com/java/java_regular_expressions.htm). 

Now I had to make sure that the form defined on ODK aggregate could actually call the BT app. I needed to define what intents the app would respond to in the app manifest. By tracing the error (in the Android device monitoring logs) that ODK generated when it couldn't find the app, I was able to identify precisely what intent the ODK form was calling. I then took that name, and defined it in an additional intent filter under my MainActivity tag in the manifest. That did the trick so that the form now opens the custom made BT app.

Then I decided to start writing tests to ensure my app was running properly and to keep functionality well documented. I began by writing some local unit tests. I hadn't done this before, so I followed [this page](http://developer.android.com/training/testing/start/index.html) for creating a simple test of the parsing method in my main activity. Then I wanted to get fancier and test what happens when I simulate starting my main activity using another app (like the ODK application.) I found [this article on creating intent tests using the Espresso framework.](http://pengj.me/android/test/2015/10/17/expresso-test-intent.html)